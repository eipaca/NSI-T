# Protocoles de routage

##	Couche Internet et adresses IP

###	Modèles OSI et TCP/IP

Communiquer consiste à transmettre des informations, mais tant que les interlocuteurs ne lui ont pas attribué un sens, il ne s'agit que de données et pas d'information. Les interlocuteurs doivent donc non seulement parler un langage commun mais aussi maîtriser des règles minimales d'émission et de réception des données. C'est le rôle d'un protocole.

!!! abstract "Cours" 
    L'ensemble des règles qui permettent à 2 ordinateurs de communiquer ensemble via un réseau s'appelle un **protocole**.

Afin de s'y retrouver au milieu des protocoles réseaux, les modèles OSI et TCP/IP permettent de les classer selon leurs niveaux d'abstractions, dans ce qu'on appelle des couches. 

!!! abstract "Cours" 
    La définition d'une **couche réseau** est assez abstraite, mais on peut dire qu'il s'agit d'un ensemble de protocoles, qui sont au même niveau d'abstraction, qui ont des fonctions similaires.

Le modèle OSI (de l'anglais Open Systems Interconnection) comporte sept couches. Le modèle TCP/IP est plus simple, il ne comporte que quatre couches : Accès au Réseau, Internet, Transport et Application.


![Schéma comparatif des couches dans les modèles OSI et TCP/IP](assets/4-modele-osi-tcp-ip-light-mode.png#only-light)
![Schéma comparatif des couches dans les modèles OSI et TCP/IP](assets/4-modele-osi-tcp-ip-dark-mode.png#only-dark)



###	Couche Accès au Réseau : les adresses MAC

![Une carte réseau Ethernet](assets/4-carte-interface-reseau.png){width="20%" align=right}


Une carte d'interface réseau -- appelée aussi carte réseau ou NIC (pour *Network Interface Controller*) -- par exemple une carte Ethernet ou WiFi, possède une adresse unique, appelée **adresse MAC** (*Media Access Control*) qui est donnée par le constructeur de la carte et qui permet de l'identifier de façon unique.

![Adresse MAC d'une machine dans un réseau Filius](assets/4-adresse-mac-machine-filius.png){width="20%" align=left}

L'adresse MAC est constituée de 6 octets écrits sous forme hexadécimale, chacun séparé par " : " (par exemple : `00:13:A9:58:32:EB`). Les 3 premiers octets définissent le constructeur de la carte réseau (ici Sony Corporation), les 3 derniers le numéro de fabrication.




Dans un réseau, un commutateur (ou *switch*) connaît les adresses MAC des machines qui lui sont branchées. 

Les paquets envoyées à l'adresse MAC `FF:FF:FF:FF:FF:FF` (adresse *broadcast*) sont envoyés à toutes les machines connectées au réseau. Le protocole ARP (*Address Resolution Protocol*) permet de lier les adresses MAC aux adresses IP correspondantes.

###	Couche Internet : les adresses IP

!!! abstract "Cours" 
    L'adresse IP permet d'identifier une machine sur un réseau. 
    
    Une machine qui possède plusieurs cartes d'interface réseau a plusieurs adresses IP, chaque adresse étant associée à une carte réseau.

Il existe actuellement deux versions du protocole IP: **IPv4 et IPv6** :

![Adresse IPv4 représentée avec des chiffres décimaux et binaires. Source: wikipedia](assets/4-adresse-ipv4-light-mode.png#only-light){width="30%" align=right}
![Adresse IPv4 représentée avec des chiffres décimaux et binaires. Source: wikipedia](assets/4-adresse-ipv4-dark-mode.png#only-dark){width="30%" align=right}

-   La version **IPv4 utilise des adresses 32 bit**s, généralement représentées en notation décimale par 4 octets (prenant les valeurs entre 0 et 255), séparés par des points.  
    
    Exemple d'adresse IPv4 :  `172.16.254.1`.
    
    Le nombre d'adresses IPv4 possibles est de $256^4 = 4{\space}294{\space}967{\space}296$. Ces adresses sont en cours « d'épuisement », c'est-à-dire qu'il n'y en a plus assez par rapport aux besoins du monde actuel.

![Adresse IPv6 représentée avec des chiffres hexadécimaux et binaires.. Source: wikipedia](assets/4-adresse-ipv6-light-mode.png#only-light){width="30%" align=right}
![Adresse IPv6 représentée avec des chiffres hexadécimaux et binaires.. Source: wikipedia](assets/4-adresse-ipv6-dark-mode.png#only-dark){width="30%" align=right}


-	La version **IPv6 utilise des adresses plus longues de 128 bits**, représentées par 8 champs de 16 bits, délimités par deux points (:). Chaque champ doit contenir un nombre hexadécimal, ou laissé vide quand il est égal à zéro.

    Exemple d'adress IPv6 : `3002:0bd6::::ee00:0033:6778`

    Le nombre d'adresses IPv6 disponibles est de $2^{128}$ c'est-à-dire $3,4 {\times} 10^{38}$  adresses, ce protocole semble donc inépuisable. 

!!! abstract "Cours" 
    L'adresse IP est inséparable de son masque de sous-réseau.  Dans le masque, les bits à 1 représentent la partie réseau de l'adresse IP, les bits à 0 représentent la partie machine. 

Comme le masque de sous-réseau est codé sur 32 bits, voici un exemple possible de masque:

|   |   |   |
|:--|:--|:--|
|   |   |`__________Réseau__________|_Machine`|
|IP|`192.168.1.45`|`11000000.10101000.00000001|00101101` |
|Masque|`255.255.255.0`|`11111111.11111111.11111111|00000000`|
|Réseau|`192.168.1.0`|`11000000.10101000.00000001|00000000`|


Prenons l'exemple d'une machine d'adresse IP `192.168.1.45` avec le masque `255.255.255.0`. Les bits des trois premiers octets du masque sont à `1`, ils donnent la partie « réseau », et les bits suivant à `0` donnent la partie « machine ». 

L'adresse dont tous les bits de la partie machine sont à `0` (`192.168.1.0`) est l'adresse du réseau entier, celle dont tous les bits de la partie machine sont à `1` (`192.168.1.255`) est l'adresse de diffusion broadcast qui permet d'envoyer un message sur tout le réseau (« *broadcast* »). Ces deux adresses sont réservées, elles ne peuvent pas être utilisées par une machine. Il reste donc  $2^8 - 2 = 254$ adresses disponibles pour les machines sur le réseau `192.168.1.0`, allant de `192.168.1.1` à `192.168.1.254`. 

- `192.168.1.0`    réservée pour l'adresse réseau

- `192.168.1.1` 

- ...

- `192.168.1.254`

- `192.168.1.255`  réservée pour l'adresse de diffusion (*broadcast*)


Pour des raisons de calcul binaire (les « `1` » du masque sont contigus), les masques de sous réseau ne peuvent prendre que les valeurs suivantes : `0` ; `128` ; `192` ; `224` ; `240` ; `248` ; `252` ; `254` ; `255`.

Une autre notation souvent utilisée, **notation CIDR**, consiste à noter directement le nombre de bits significatifs en décimal. Ainsi `192.168.25.0/255.255.255.0` peut aussi écrire `192.168.25.0/24`, car le masque réseau est sur 24 bits.
De même `10.0.0.0/255.0.0.0` peut aussi s'écrire `10.0.0.0/8` ou `192.168.1.192/255.255.255.240` peut s'écrire `192.168.1.192/28`.


Il est facile d'identifier les parties réseau et machine d'une adresse IPv4 quand le masque ne comporte que des 255 et des 0, ou un multiple de 8 en notation CIDR, mais ce n'est pas aussi simple pour les autres valeurs de masque -- `128` ; `192` ; `224` ; `240` ; `248` ; `252` ; `254` -- il faut alors "découper" un octet ! Prenons l'exemple de l'adresse `192.168.1.192/255.255.255.240` ou `192.168.1.192/28` en notation CIDR : 

- L'adresse IP `192.168.1.192` s'écrit en binaire `11000000.10101000.00000001.11000000`. 

- Le masque IP `255.255.255.240` s'écrit en binaire `11111111.11111111.11111111.11110000`. 

Dans ce cas, la partie réseau est déterminée par les 28 premiers bits de l'adresse (ceux qui sont à `1`). Elle est obtenue par un `ET` logique entre l'adresse IP et son masque. Tous les bits de l'adresse qui correspondent à un `1` du masque sont gardés, les autres sont remplacés par des `0` : 

|   |   |`___________Réseau_____________|Machine`|
|:--|:--|:--|
|IP|`192.168.1.45 `|`11000000.10101000.00000001.1100|0000` |
|Masque|`255.255.255.240`|`11111111.11111111.11111111.1111|0000`|
|Réseau|`192.168.1.192`|`11000000.10101000.00000001.1100|0000`|

La partie réseau de l'adresse est donc `11000000.10101000.00000001.11000000` autrement dit `192.168.1.192`. 
Les adresses disponibles sur ce réseau sont donc :

- `11000000.10101000.00000001.1100|0000` c'est-à-dire `192.168.1.192`    réservée pour l'adresse réseau

- `11000000.10101000.00000001.1100|0001` c'est-à-dire `192.168.1.193`
- `11000000.10101000.00000001.1100|0010` c'est-à-dire `192.168.1.194`

- ...
- `11000000.10101000.00000001.1100|1110` c'est-à-dire `192.168.1.206`
- `11000000.10101000.00000001.1100|1111` c'est-à-dire `192.168.1.207` réservée pour l'adresse de diffusion (*broadcast*)

Les adresses diponbibles pour les ordinateurs sur ce réseau vont de `192.168.1.193` à `192.168.1.206`, il y en a donc $2^4 - 2 = 14$.

!!! question "Exercice corrigé" 
	On donne l'adress IPv4 d'une machine `192.168.2.60/25`.
    Déterminer l'adresse de ce réseau et les adresses possibles des autres machines sur ce réseau.
        

??? Success "Réponse"
    Ecrivons l'adresse IP en binaire et séparons la partie réseau (les 25 premiers bits) de l apartie machine (les 7 bits suivants) : 

    |   |   |`___________Réseau____________|Machine`|
    |:--|:--|:--|
    |IP|`192.168.2.60 `|`11000000.10101000.00000010.0|0111100` |
    |Masque|25 bits|`11111111.11111111.11111111.1|0000000`|
    |Réseau|`192.168.1.192`|`11000000.10101000.00000010.0|0000000`|
    
    Les adresses disponibles sur ce réseau sont donc :

    - `11000000.10101000.00000010.0|0000000` c'est-à-dire `192.168.2.0` (adresse réseau)
    - `11000000.10101000.00000010.0|0000001` c'est-à-dire `192.168.2.1`
    - `11000000.10101000.00000010.0|0000010` c'est-à-dire `192.168.2.2`
        - ...
    - `11000000.10101000.00000010.0|1111110` c'est-à-dire `192.168.2.126`
    - `11000000.10101000.00000010.0|1111111` c'est-à-dire `192.168.2.127` (adresse de diffusion (*broadcast*)) 

    L'adresse du réseau est `192.168.2.0/25`.

    Il y a $2^7 - 2 = 126$ adresses machine disponibles, allant de `192.168.2.1` à `192.168.2.126`.





## Routage

Pour que deux machines (ordinateurs, imprimantes, etc.) puissent communiquer entre elles, il faut qu'elles soient  sur le même réseau, c'est-à-dire :

- 	physiquement connectées (reliées pas un câble, sur le même bus, reliés au même commutateur/switch,…) ; et
-	logiquement sur le même réseau (avec la  même adresse de réseau).

Mais comment faire pour communiquer entre machines qui sont sur des réseaux différents ?

### Routeurs

!!! abstract "Cours" 
    Des machines qui ne sont pas sur un même réseau peuvent communiquer par le biais d'un ou plusieurs routeurs qui relayent (ou « commutent ») les **paquets d'information** vers  les adresses IP d'un réseau à l'autre[^4.1] . 
    
    Chaque routeur dispose de **plusieurs interfaces de cartes réseaux** permettant de communiquer sur **plusieurs réseaux**[^4.2]. 

[^4.1]: Contrairement aux  commutateurs (ou **swithc**)) qui se basent sur les adresses MAC et  sont limités à un réseau local.

[^4.2]: Une box de Fournisseur d'Accès à Internet (FAI) est un routeurs qui a souvent 3  interfaces : 

    - une interface connectée au réseau de l'opérateur (FAI). 
    - une interface filaire (Ethernet) connectée au réseau local. 
    - une interface Wifi.


Voici un exemple de plusieurs routeurs relayant les informations entre deux réseaux locaux séparés.

![Un exemple de routage entre deux réseaux locaux à travers 6 routeurs](assets/4-routage-entre-reseaux-locaux-6-routeurs-light-mode.png#only-light){width="80%"}
![Un exemple de routage entre deux réseaux locaux à travers 6 routeurs](assets/4-routage-entre-reseaux-locaux-6-routeurs-dark-mode.png#only-dark){width="80%"}


### Tables de routage

Dans l'exemple précédent, quand un routeur reçoit un paquet du Client destiné au Serveur, comment sait-il à quel autre routeur faire suivre le paquet ? 

!!! abstract "Cours" 
    La **table de routage** de chaque routeur associe les adresses de destination finales aux adresses de ses routeurs voisins pour déterminer vers lequel transmettre les paquets.

Les tables de routage des routeurs, ou de n'importe quelle machine présente sur le réseau[^4.3],  contiennent des informations de routage sur **quatre colonnes** :

-   la première contient un "**Réseau de destination**" sous la forme d'une adresse IP sous-réseau/masque.

-	la deuxième, nommée "**Passerelle**" (ou *gateway*), donne l'adresse IP du prochain routeur voisin par lequel passer pour atteindre cette destination.

    -   Les passerelles indiquées dans les tables de routage appartiennent toujours à l'un des réseaux du routeur.
    -   La passerelle est vide quand l'adresse de destination est celle d'un routeur voisin

![Cartes d'interface de R1 dans l'exemple précédent](assets/4-cartes-interface-r1-light-mode.png#only-light){width="30%" align=right}
![Cartes d'interface de R1 dans l'exemple précédent](assets/4-cartes-interface-r1-dark-mode.png#only-dark){width="30%" align=right}


-   Une colonne "**Interface**" indique l'interface réseau à utiliser pour atteindre la passerelle ou la destination finale. Il peut s'agir par exemple d'une carte Ethernet ou d'une interface sans fil comme une borne Wi-Fi nommées `eth0`, `eth1`,`wlan0` ou on peut aussi utiliser l'adresse IP, la machine fait le lien entre le nom et l'adresse.

-   Enfin, la dernière colonne contient une **Métrique** qui mesure de la « distance » qui sépare un routeur d'un réseau de destination. Plus sa valeur est faible, meilleure est la route. Chaque protocole dispose de sa méthode de valorisation (en nombre de saut ou bande passante, etc.).

[^4.3]: Toute machine connectée à un réseau possède une table de routage, une imprimante, un téléphone, etc.

Voici un exemple de table de routage de R1 dans le réseau précédent :

![Table de routage de R1 dans l'exemple précédent](assets/4-exemple-table-routage-r1-light-mode.png#only-light){width="80%"}
![Table de routage de R1 dans l'exemple précédent](assets/4-exemple-table-routage-r1-dark-mode.png#only-dark){width="80%"}

Toutes les machines sur un réseau ont une table de routage.  On peut  observer la table de routage de son ordinateur avec : 
-	route print (windows et cygwin) 
-	ip route (linux)

### Routage

Observons le trajet d'un paquet allant de l'ordinateur 198.168.1.101 au serveur `192.168.4.101` dans le réseau suivant (tous les masques réseaux sont `255.255.255.0`).


![Un exemple de routage entre deux réseaux locaux à travers 2 routeurs](assets/4-routage-entre-reseaux-locaux-2-routeurs-light-mode.png#only-light){width="80%"}
![Un exemple de routage entre deux réseaux locaux à travers 26 routeurs](assets/4-routage-entre-reseaux-locaux-2-routeurs-dark-mode.png#only-dark){width="80%"}


![Tables de routage entre deux réseaux locaux à travers 2 routeurs](assets/4-routage-entre-reseaux-locaux-2-routeurs-tables-light-mode.png#only-light){width="60%"}
![Tables de routage entre deux réseaux locaux à travers 26 routeurs](assets/4-routage-entre-reseaux-locaux-2-routeurs-tables-dark-mode.png#only-dark){width="60%"}

① Le paquet est envoyé par l'ordinateur `198.168.1.101`, sa table de routage  ne connait pas l'adresse du réseau de destination (`192.168.4.0`), le paquet suit donc la route par défaut il est envoyé au routeur R1 à l'adresse `192.168.1.100` par l'interface eth0 de l'ordinateur.

② Le paquet arrive sur le routeur R1, l'adresse du réseau de destination  (`192.168.4.0`) est connue de la table de routage de R1, le paquet est envoyé au routeur R2 à l'adresse `192.168.3.102` par l'interface `eth1` de R1.

③Le paquet arrive sur le routeur R2, l'adresse du serveur de destination  (`192.168.4.101`) est directement accessible par l'interface `eth1` de R2, le routeur lui fait suivre le paquet qui arrive à destination.

!!! abstract "Cours" 
    Le **routage** est le mécanisme par lequel les paquets sont acheminés par les routeurs depuis un expéditeur jusqu'au destinataire.


##	Rôle des protocoles de routage

Le nombre de routeurs dans un réseau est généralement trop grand pour configurer les tables de routage à la main  et chaque fois qu'un routeur tombe en panne ou qu'une modification arrive (ajout d'une nouvelle liaison ou d'un nouveau routeur), il faudrait recalculer toutes les routes et de mettre à jour les tables de routage de chaque routeur.

Alors comment être sûr que les tables de routages seront toujours à jour pour donner le meilleur chemin (le plus court, le plus pertinent, etc...) entre routeurs et pour que le paquet arrive à destination sans se perdre et être détruit  ? 

!!! abstract "Cours" 
    Les  **protocoles de routage** permettant aux **routeurs d'échanger les informations sur le réseau** afin de mettre à jour automatiquement leur table de routage avec les meilleures routes possibles.

Un algorithme permet de comparer les routes en utilisant une **métrique**. Plus sa valeur est faible, meilleure est la route. Les protocoles à **vecteurs de distance** (RIP, IGRP, etc.) utilisent la distance en nombre de routeurs, alors que ceux à **états de lien** (OSPF, IS-IS, etc.) utilisent le débit des connexions entre routeurs

###	RIP : protocole à vecteurs de distance

### OSPF: protocole à état de liens
